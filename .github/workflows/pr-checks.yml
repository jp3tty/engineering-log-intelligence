name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.12'

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better analysis
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run security checks
      run: |
        echo "🔒 Running security checks..."
        pip install bandit safety
        bandit -r api/ -f json -o bandit-report.json || true
        safety check --json --output safety-report.json || true
        
    - name: Check for TODO/FIXME comments
      run: |
        echo "📝 Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" api/ --exclude-dir=__pycache__; then
          echo "⚠️  Found TODO/FIXME comments. Consider addressing them before merging."
        else
          echo "✅ No TODO/FIXME comments found."
        fi
        
    - name: Check code complexity
      run: |
        echo "📊 Checking code complexity..."
        pip install radon
        radon cc api/ --min B --show-complexity --show-closures
        
    - name: Generate code quality report
      run: |
        echo "📋 Generating code quality report..."
        echo "# Code Quality Report" > quality-report.md
        echo "## Black Formatting" >> quality-report.md
        black --check --diff api/ >> quality-report.md || true
        echo "" >> quality-report.md
        echo "## Flake8 Linting" >> quality-report.md
        flake8 api/ >> quality-report.md || true
        echo "" >> quality-report.md
        echo "## MyPy Type Checking" >> quality-report.md
        mypy api/ >> quality-report.md || true
        
    - name: Upload quality report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
